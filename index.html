<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ ãƒãƒ¼ã‚ºå½“ã¦ã‚²ãƒ¼ãƒ ï¼ˆéŸ³å£°ä»˜ãï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { 
    background:#ffffff;
    text-align:center; 
    margin:0; 
    font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  h2 {
    margin: 10px 0 0;
    font-size:20px;
  }
  #gameCanvas{
    background:#ffffff;
    display:block;
    margin:10px auto 0;
    border:2px solid #ddd; 
    border-radius: 8px;
  }
  #info {
    margin-top:8px;
    font-size:14px;
    line-height:1.6;
  }
  button{
    margin-top:10px;
    padding:10px 24px;
    font-size:18px;
    border-radius:999px;
    border:none;
    background:#111;
    color:#fff;
    cursor:pointer;
  }
  button:active{ transform:scale(0.97); }
  #message {
    margin-top:6px;
    min-height:1.5em;
    font-size:14px;
  }
</style>
</head>
<body>

<h2>â–¶ ã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ ãƒãƒ¼ã‚ºå½“ã¦ã‚²ãƒ¼ãƒ </h2>

<canvas id="gameCanvas" width="400" height="650"></canvas>

<div id="info">
  ãƒ©ã‚¦ãƒ³ãƒ‰ï¼š<span id="round">0</span> / 5ã€€
  ã‚¹ã‚³ã‚¢ï¼š<span id="score">0</span> ç‚¹
  <div id="message">ç”»åƒèª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</div>
</div>

<button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ / ãƒªãƒˆãƒ©ã‚¤</button>

<script>
  const cvs = document.getElementById("gameCanvas");
  const ctx = cvs.getContext("2d");

  // èƒŒæ™¯ç”»åƒï¼ˆã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ç›¤é¢ï¼‰
  const bg = new Image();
  bg.src = "background.png";

  // ãƒãƒ¼ã‚ºç”»åƒ
  const pose = new Image();
  pose.src = "pose.png";

  // éŸ³å£°
  const timeshock = new Audio("timeshock.mp3"); // å®Œå…¨ä¸€è‡´
  const boo       = new Audio("boo.mp3");       // ãƒã‚ºãƒ¬

  const MAX_ROUNDS = 5;

  let loadedPose = false;
  let loadedBg   = false;
  let playing = false;
  let round = 0;
  let totalScore = 0;

  // ã‚­ãƒ£ãƒ©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  let x = -300;
  let speed = 4;
  const targetX = 200;
  const baseY  = 0;
  const w = 300;
  const h = 600;

  const roundEl  = document.getElementById("round");
  const scoreEl  = document.getElementById("score");
  const msgEl    = document.getElementById("message");
  const startBtn = document.getElementById("startBtn");

  // èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚¯
  function checkLoaded() {
    if (loadedPose && loadedBg) {
      msgEl.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
      draw();
    }
  }

  pose.onload = () => { loadedPose = true; checkLoaded(); };
  bg.onload   = () => { loadedBg = true;   checkLoaded(); };

  pose.onerror = () => alert("pose.png ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼");
  bg.onerror   = () => alert("background.png ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼");

  // æç”»
  function draw() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    // èƒŒæ™¯
    ctx.drawImage(bg, 0, 0, cvs.width, cvs.height);

    // ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆä¸­å¤®ï¼‰
    ctx.strokeStyle = "rgba(0,0,0,0.15)";
    ctx.beginPath();
    ctx.moveTo(cvs.width / 2, 0);
    ctx.lineTo(cvs.width / 2, cvs.height);
    ctx.stroke();

    // ä¸­å¤®ã®æ·¡ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
    ctx.globalAlpha = 0.25;
    ctx.drawImage(pose, targetX - w / 2, baseY, w, h);
    ctx.globalAlpha = 1.0;

    // å‹•ãã‚­ãƒ£ãƒ©
    ctx.drawImage(pose, x, baseY, w, h);
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  function loop() {
    if (!playing) return;

    x += speed;
    if (x > cvs.width) x = -w;

    draw();
    requestAnimationFrame(loop);
  }

  // ã‚²ãƒ¼ãƒ é–‹å§‹
  function startGame() {
    if (!loadedPose || !loadedBg) {
      alert("ç”»åƒèª­ã¿è¾¼ã¿ä¸­ã§ã™");
      return;
    }
    round = 0;
    totalScore = 0;
    scoreEl.textContent = totalScore;
    nextRound();
  }

  // ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
  function nextRound() {
    round++;
    if (round > MAX_ROUNDS) {
      endGame();
      return;
    }

    roundEl.textContent = round;
    msgEl.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}ï¼šã“ã“ã ï¼ã¨æ€ã£ãŸã‚‰ã‚¿ãƒƒãƒ— or ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼`;

    x = -w;
    speed = 3 + round * 0.7;

    playing = true;
    loop();
  }

  // â˜…åœæ­¢ï¼‹åˆ¤å®šï¼ˆä»Šå›ã®é‡è¦éƒ¨åˆ†ï¼‰
  function stopAndJudge() {
    if (!playing) return;
    playing = false;

    const diff = Math.abs(x - (targetX - w / 2)); 

    // â˜…å®Œå…¨ä¸€è‡´ï¼ˆ8pxä»¥å†…ï¼‰ã ã‘æˆåŠŸ
    if (diff < 8) {
      totalScore += 100;
      scoreEl.textContent = totalScore;
      msgEl.textContent = `ğŸ”¥ å®Œå…¨ä¸€è‡´ï¼ï¼ +100ç‚¹`;

      try {
        timeshock.currentTime = 0;
        timeshock.play();
      } catch(e) {}

    } else {
      // â˜…å°‘ã—ã§ã‚‚ã‚ºãƒ¬ãŸã‚‰å…¨éƒ¨ãƒã‚ºãƒ¬
      msgEl.textContent = `âŒ å°‘ã—ã‚ºãƒ¬ã¦ã¾ã™â€¦`;
      try {
        boo.currentTime = 0;
        boo.play();
      } catch(e) {}
    }

    if (round < MAX_ROUNDS) {
      setTimeout(nextRound, 1000);
    } else {
      setTimeout(endGame, 1000);
    }
  }

  // çµ‚äº†
  function endGame() {
    playing = false;
    msgEl.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ åˆè¨ˆ ${totalScore} ç‚¹ã§ã—ãŸã€‚`;
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener("click", startGame);
  cvs.addEventListener("pointerdown", stopAndJudge);
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      stopAndJudge();
    }
  });
</script>

</body>
</html>
