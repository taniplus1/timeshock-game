<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ ãƒãƒ¼ã‚ºå½“ã¦ã‚²ãƒ¼ãƒ ï¼ˆéŸ³å£°ä»˜ãï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { 
    background:#ffffff;
    text-align:center; 
    margin:0; 
    font-family:-apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  h2 {
    margin: 10px 0 0;
    font-size:20px;
  }
  #gameCanvas{
    background:#ffffff;
    display:block;
    margin:10px auto 0;
    border:2px solid #ddd; 
    border-radius: 8px;
  }
  #info {
    margin-top:8px;
    font-size:14px;
    line-height:1.6;
  }
  button{
    margin-top:10px;
    padding:10px 24px;
    font-size:18px;
    border-radius:999px;
    border:none;
    background:#111;
    color:#fff;
    cursor:pointer;
  }
  button:active{ transform:scale(0.97); }
  #message {
    margin-top:6px;
    min-height:1.5em;
    font-size:14px;
  }
</style>
</head>
<body>

<h2>â–¶ ã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ ãƒãƒ¼ã‚ºå½“ã¦ã‚²ãƒ¼ãƒ </h2>

<canvas id="gameCanvas" width="400" height="650"></canvas>

<div id="info">
  ãƒ©ã‚¦ãƒ³ãƒ‰ï¼š<span id="round">0</span> / 5ã€€
  ã‚¹ã‚³ã‚¢ï¼š<span id="score">0</span> ç‚¹
  <div id="message">ç”»åƒèª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</div>
</div>

<button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ / ãƒªãƒˆãƒ©ã‚¤</button>

<script>
  const cvs = document.getElementById("gameCanvas");
  const ctx = cvs.getContext("2d");

  const pose = new Image();
  pose.src = "pose.png";     // â† åŒã˜ãƒ•ã‚©ãƒ«ãƒ€å†…ã® pose.png

  // â˜…ã€Œã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ï¼ã€éŸ³å£°
  const timeshock = new Audio("timeshock.mp3");

  const MAX_ROUNDS = 5;

  let loaded = false;
  let playing = false;
  let round = 0;
  let totalScore = 0;

  // ã‚­ãƒ£ãƒ©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  let x = -300;
  let speed = 4;
  const targetX = 200;    // ç”»é¢ä¸­å¤®ã‚ãŸã‚Š
  const baseY  = 0;     // Yä½ç½®
  const w = 300;
  const h = 600;

  const roundEl  = document.getElementById("round");
  const scoreEl  = document.getElementById("score");
  const msgEl    = document.getElementById("message");
  const startBtn = document.getElementById("startBtn");

  // ç”»åƒèª­ã¿è¾¼ã¿
  pose.onload = () => {
    loaded = true;
    msgEl.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
    draw();
  };

  pose.onerror = () => {
    msgEl.textContent = "pose.png ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚åå‰ã¨å ´æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    alert("pose.png ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚\nindex.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã€pose.pngã€ã«ã—ã¦ãã ã•ã„ã€‚");
  };

  // æç”»å‡¦ç†
  function draw() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    // ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆä¸­å¤®ï¼‰
    ctx.strokeStyle = "rgba(0,0,0,0.1)";
    ctx.beginPath();
    ctx.moveTo(cvs.width / 2, 0);
    ctx.lineTo(cvs.width / 2, cvs.height);
    ctx.stroke();

    // ä¸­å¤®ã®è–„ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
    ctx.globalAlpha = 0.25;
    ctx.drawImage(pose, targetX - w / 2, baseY, w, h);
    ctx.globalAlpha = 1.0;

    // å‹•ã„ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©
    ctx.drawImage(pose, x, baseY, w, h);
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
  function loop() {
    if (!playing) return;

    x += speed;
    if (x > cvs.width) x = -w;

    draw();
    requestAnimationFrame(loop);
  }

  // ã‚²ãƒ¼ãƒ é–‹å§‹
  function startGame() {
    if (!loaded) {
      alert("pose.png ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    round = 0;
    totalScore = 0;
    scoreEl.textContent = totalScore;
    nextRound();
  }

  // å„ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹
  function nextRound() {
    round++;
    if (round > MAX_ROUNDS) {
      endGame();
      return;
    }

    roundEl.textContent = round;
    msgEl.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}ï¼šå‹•ããƒãƒ¼ã‚ºã‚’ã‚ˆãè¦‹ã¦ã€ã“ã“ã ï¼ã§ã‚¿ãƒƒãƒ— or ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼`;

    x = -w;
    speed = 3 + round * 0.7;

    playing = true;
    loop();
  }

  // åœæ­¢ï¼‹åˆ¤å®š
  function stopAndJudge() {
    if (!playing) return;
    playing = false;

    const diff = Math.abs(x - (targetX - w / 2)); // å·¦ç«¯åŒå£«ã®å·®

    let score;
    if (diff < 8)      score = 100;
    else if (diff <20) score = 70;
    else if (diff <40) score = 40;
    else               score = 10;

    totalScore += score;
    scoreEl.textContent = totalScore;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼†éŸ³å£°
    if (diff < 8) {
      msgEl.textContent = `ğŸ”¥ å®Œå…¨ä¸€è‡´ãƒ¬ãƒ™ãƒ«ï¼+${score}ç‚¹`;
      try {
        timeshock.currentTime = 0;
        timeshock.play();   // â˜…ã“ã“ã§ã€Œã‚¿ã‚¤ãƒ ã‚·ãƒ§ãƒƒã‚¯ï¼ã€å†ç”Ÿ
      } catch(e) {
        console.log("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e);
      }
    } else if (diff < 20) {
      msgEl.textContent = `ã‹ãªã‚Šè¿‘ã„ï¼+${score}ç‚¹`;
    } else if (diff < 40) {
      msgEl.textContent = `ã¾ãšã¾ãšï¼+${score}ç‚¹`;
    } else {
      msgEl.textContent = `ã¾ã ã‚ºãƒ¬ã¦ã‚‹â€¦ +${score}ç‚¹`;
    }

    if (round < MAX_ROUNDS) {
      setTimeout(nextRound, 1000);
    } else {
      setTimeout(endGame, 1000);
    }
  }

  // ã‚²ãƒ¼ãƒ çµ‚äº†
  function endGame() {
    playing = false;
    msgEl.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ åˆè¨ˆ ${totalScore} ç‚¹ã§ã—ãŸã€‚`;
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  startBtn.addEventListener("click", startGame);
  cvs.addEventListener("pointerdown", stopAndJudge);
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      stopAndJudge();
    }
  });
</script>

</body>
</html>